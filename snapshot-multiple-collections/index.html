<!DOCTYPE html>
<html>
<head>
  <title>Snapshot Multiple Collections</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    #title {
      text-align: center;
      font-size: 24px;
      font-weight: bold;
    }
    #text-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
    }
    #input-label {
      font-weight: bold;
    }
    #api-key-input,
    #collection-addresses-input {
      margin-top: 10px;
      padding: 5px;
      width: 350px;
      border: 1px solid #bbb;
      border-radius: 5px;
    }
    #snapshot-button {
      padding: 10px;
      border-radius: 5px;
      border: none;
      color: white;
      background-color: #007bff;
      cursor: pointer;
    }
    #snapshot-button[disabled] {
      background-color: #ccc;
    }
    #log-box {
      margin-top: 20px;
      padding: 5px;
      width: 350px;
      height: 200px;
      border: 1px solid #bbb;
      border-radius: 5px;
      overflow: auto;
      white-space: pre-wrap;
    }
	#sticky-link {
	  position: fixed;
	  top: 10px;
	  left: 10px;
	  background-color: white;
	  padding: 5px;
	  border-radius: 5px;
	  text-decoration: underline;
	  color: #ff3d00;
	}
	
  </style>
</head>
<body>
  <a id="sticky-link" href="../">Scatter Partners Webtools</a>
  
  <div id="title">Snapshot Multiple Collections</div>
  <div id="text-container">
    <label id="input-label" for="api-key-input"><a href="https://www.alchemy.com/">Alchemy</a> API Key:</label>
    <input id="api-key-input" type="text" placeholder="Enter Alchemy API key">
    <label id="input-label" for="collection-addresses-input">Collection Addresses (one per line):</label>
    <textarea id="collection-addresses-input" rows="20" cols="40"></textarea>
  </div>
  <button id="snapshot-button">Get Multi-Snapshot</button>
  <textarea id="log-box" readonly></textarea>
  <script>
    let snapshotButton = document.getElementById('snapshot-button');
    let apiKeyInput = document.getElementById('api-key-input');
    let collectionAddressesInput = document.getElementById('collection-addresses-input');
    let logBox = document.getElementById('log-box');

    snapshotButton.onclick = async function() {
      let apiKey = apiKeyInput.value.trim();
      let collectionAddresses = collectionAddressesInput.value.trim().split('\n');

      if (!apiKey) {
        alert('Please enter your Alchemy API key.');
        return;
      }

      if (!collectionAddresses[0]) {
        alert('Please enter at least one collection address.');
        return;
      }

      snapshotButton.disabled = true;
      snapshotButton.innerText = 'Please wait...';

      logBox.value += 'Snapshotting collections...\n';

      try {
        await snapshotCollections(apiKey, collectionAddresses);
        logBox.value += 'Snapshot complete.\n';
      } catch (error) {
        logBox.value += 'Error snapshotting collections: ' + error + '\n';
      }

      snapshotButton.disabled = false;
      snapshotButton.innerText = 'Get Multi-Snapshot';
    };

    async function snapshotCollections(apiKey, collectionAddresses) {
      let mergedLines = [];

      for (let address of collectionAddresses) {
        const fetchURL = `https://eth-mainnet.g.alchemy.com/nft/v2/${apiKey}/getOwnersForCollection?contractAddress=${address}&withTokenBalances=false`;

        logBox.value += 'Fetching owners for ' + address + '...\n';

        let response = await fetch(fetchURL);

        if (!response.ok) {
          throw new Error('Received HTTP ' + response.status + ' from Alchemy API.');
        }

        let data = await response.json();
        mergedLines.push(...data.ownerAddresses);

        logBox.value += 'Fetched ' + data.ownerAddresses.length + ' owner(s) for ' + address + '.\n';
      }

      const uniqueLines = [...new Set(mergedLines)];
      const blob = new Blob([uniqueLines.join('\n')], { type: 'text/plain' });

      saveAs(blob, `output-${Date.now()}.txt`);
    }
  </script>
</body>
</html>
